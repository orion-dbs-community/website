---
title: "Sesam Open"
format:
  html:
    page-layout: full
---

A great collection powered by Bianca Kramer

...

```{r}
#| echo: false
#| message: false
library(tidyverse)
library(bigrquery)
library(reactable)
library(htmltools)

bigrquery::bq_auth()
```

```{r}
#| echo: false
my_datasets <- bq_project_datasets("sos-datasources")

# Function to extract nested fields from RECORD type
get_nested_fields <- function(field) {
  if (field$type == "RECORD" && !is.null(field$fields)) {
    tibble::tibble(
      Field = map_chr(field$fields, "name"),
      Type = map_chr(field$fields, "type"),
      Description = map_chr(field$fields, \(x) x$description %||% NA_character_)
    )
  } else {
    NULL
  }
}
```

```{r}
#| echo: false
#| results: asis

# Render a section for each dataset
for (dataset in my_datasets) {
  # Print dataset name as heading
  cat(paste0("## ", dataset$dataset, "\n\n"))

  # Get dataset metadata
  dataset_meta <- bq_dataset_meta(dataset)

  # Create HTML for dataset metadata with styled box
  dataset_info_html <- paste0(
    '<div style="margin-bottom: 1.5rem; padding: 12px; background-color: #f8f9fa; border-left: 3px solid hsl(213, 55%, 50%); border-radius: 4px;">',
    if (!is.null(dataset_meta$description) && dataset_meta$description != "") {
      paste0(
        '<div style="font-weight: 600; margin-bottom: 0.5rem; color: hsl(213, 13%, 33%); font-size: 0.875rem;">Description</div>',
        '<div style="color: hsl(213, 13%, 25%); font-size: 0.9375rem; margin-bottom: 0.75rem;">',
        dataset_meta$description,
        '</div>'
      )
    } else "",
    '<div style="color: hsl(213, 13%, 25%); font-size: 0.875rem;">',
    '<strong>Created:</strong> ',
    strftime(as.POSIXct(as.numeric(dataset_meta$creationTime) / 1000, origin = "1970-01-01"),
             format = "%b %d, %Y %H:%M"),
    ' | <strong>Location:</strong> ', dataset_meta$location,
    '</div>',
    '</div>\n\n'
  )

  cat(dataset_info_html)

  # Set the current dataset for the child document
  current_dataset <- dataset

  # Render the child document
  res <- knitr::knit_child("_dataset_table.qmd", quiet = TRUE, envir = environment())
  cat(res, sep = "\n")
  cat("\n\n")
}
```
