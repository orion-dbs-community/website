---
title: "MultiObs"
format:
  html:
    page-layout: full
toc-title: Datasets
params:
  bq_project: "multiobs"
---

The datasets here are part of a research project at the University of Campinas (UNICAMP) to develop a broad research program to create evidence and knowledge for more effective monitoring of Science, Technology, and Innovation (STI). The program addresses critical and contemporary issues in STI indicators and policy making, addressing pervasive challenges regarding data infrastructures, funding dynamics, and society and policy engagement with STI. We create a novel framework for STI monitoring that federates data infrastructures, and adopts participatory and multi-perspective approaches. We include data about research entities, bibliometrics, economics, intellectual property, among others.

Preprocessing code can be found at <https://github.com/multiobs-ig-unicamp/>.

```{r}
#| echo: false
#| message: false
library(tidyverse)
library(bigrquery)
library(reactable)
library(htmltools)

# Write credentials to temp file if BQ_ORI contains JSON content
bq_ori <- Sys.getenv("BQ_ORI")
if (bq_ori != "") {
  if (file.exists(bq_ori)) {
    # BQ_ORI is a file path
    bigrquery::bq_auth(path = bq_ori)
  } else {
    # BQ_ORI contains JSON content (from GitHub Actions)
    temp_key <- tempfile(fileext = ".json")
    cat(bq_ori, file = temp_key)
    bigrquery::bq_auth(path = temp_key)
  }
}
```

```{r}
#| echo: false
my_datasets <- bq_project_datasets(params$bq_project)

# Function to recursively extract nested fields from RECORD type
get_nested_fields <- function(field) {
  if (field$type == "RECORD" && !is.null(field$fields)) {
    tibble::tibble(
      Field = map_chr(field$fields, "name"),
      Type = map_chr(field$fields, "type"),
      Description = map_chr(field$fields, \(x) x$description %||% NA_character_),
      nested_fields = map(field$fields, get_nested_fields)
    )
  } else {
    NULL
  }
}
```

```{r}
#| echo: false
#| results: asis

datasets_with_meta <- list()

# Render a section for each dataset
for (dataset in my_datasets) {
  # Print dataset name as heading
  cat(paste0("## ", dataset$dataset, "\n\n"))

  # Get dataset metadata
  dataset_meta <- bq_dataset_meta(dataset)

  # Create HTML for dataset metadata with styled box
  dataset_url <- paste0(
    'https://console.cloud.google.com/bigquery?project=', dataset$project,
    '&p=', dataset$project,
    '&d=', dataset$dataset,
    '&page=dataset'
  )

  dataset_info_html <- paste0(
    '<div class="description-box">',
    if (!is.null(dataset_meta$description) && dataset_meta$description != "") {
      paste0(
        '<div class="description-header">Description</div>',
        '<div class="description-content" style="margin-bottom: 0.75rem;">',
        dataset_meta$description,
        '</div>'
      )
    } else "",
    '<div class="description-meta">',
    '<strong>Created:</strong> ',
    strftime(as.POSIXct(as.numeric(dataset_meta$creationTime) / 1000, origin = "1970-01-01"),
             format = "%b %d, %Y %H:%M"),
    ' | <strong>Location:</strong> ', dataset_meta$location,
    ' | <a href="', dataset_url, '" target="_blank">View in BigQuery Console</a>',
    '</div>',
    '</div>\n\n'
  )

  cat(dataset_info_html)

  # Set the current dataset for the child document
  current_dataset <- dataset

  # Render the child document
  res <- knitr::knit_child("../_dataset_table.qmd", quiet = TRUE, envir = environment())
  cat(res, sep = "\n")
  cat("\n\n")

  # Accumulate metadata for snapshot
  datasets_with_meta[[dataset$dataset]] <- list(
    meta   = dataset_meta,
    tables = map(bq_dataset_tables(dataset), bq_table_meta)
  )
}
```

```{r}
#| echo: false
#| message: false
source(rprojroot::find_root_file("collect_collection_info.R", criterion = rprojroot::has_file("DESCRIPTION")))
snapshot_collection_info(params$bq_project, datasets_with_meta)
```
