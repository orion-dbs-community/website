```{r}
#| echo: false

my_tables <- bq_dataset_tables(current_dataset)

# Get metadata for all tables
table_metadata <- map_dfr(my_tables, function(table) {
  meta <- bq_table_meta(table)

  # Extract schema fields with nested information
  schema_fields <- if (!is.null(meta$schema$fields)) {
    list(tibble::tibble(
      Field = map_chr(meta$schema$fields, "name"),
      Type = map_chr(meta$schema$fields, "type"),
      Description = map_chr(meta$schema$fields, \(x) x$description %||% NA_character_),
      nested_fields = map(meta$schema$fields, get_nested_fields)
    ))
  } else {
    list(NULL)
  }

  tibble::tibble(
    name = meta$tableReference$tableId,
    lastModifiedTime = as.POSIXct(as.numeric(meta$lastModifiedTime) / 1000, origin = "1970-01-01"),
    location = meta$location,
    numBytes = as.numeric(meta$numBytes),
    numRows = as.numeric(meta$numRows),
    description = meta$description %||% NA_character_,
    schema = schema_fields
  )
})

# Row details function for table metadata
table_details <- function(index) {
  schema_data <- table_metadata$schema[[index]]
  table_desc <- table_metadata$description[[index]]
  table_name <- table_metadata$name[[index]]

  if (!is.null(schema_data)) {
    # Create BigQuery console URL for the table
    table_url <- paste0(
      'https://console.cloud.google.com/bigquery?project=', current_dataset$project,
      '&p=', current_dataset$project,
      '&d=', current_dataset$dataset,
      '&t=', table_name,
      '&page=table'
    )

    # Create description section if description exists
    desc_section <- if (!is.na(table_desc) && table_desc != "") {
      tagList(
        div(
          class = "description-box",
          div(
            class = "description-header",
            "Description"
          ),
          div(
            class = "description-content",
            table_desc
          ),
          tags$div(
            style = "margin-top: 0.5rem; font-size: 0.9rem;",
            tags$a(href = table_url, target = "_blank", "View in BigQuery Console")
          )
        )
      )
    } else {
      NULL
    }

    detail <- div(
      class = "schema-detail",
      desc_section,
      div(class = "schema-header", "Table Schema"),
      reactable(
        schema_data,
        pagination = FALSE,
        outlined = TRUE,
        defaultColDef = colDef(headerClass = "header"),
        columns = list(
          Field = colDef(
            name = "Field",
            minWidth = 200,
            style = list(fontWeight = 500, fontSize = "0.8125rem")
          ),
          Type = colDef(
            name = "Type",
            minWidth = 100,
            style = list(fontSize = "0.8125rem")
          ),
          Description = colDef(
            name = "Description",
            minWidth = 250,
            style = list(fontSize = "0.8125rem")
          ),
          nested_fields = colDef(show = FALSE)
        ),
        details = function(schema_index) {
          nested_data <- schema_data$nested_fields[[schema_index]]
          if (!is.null(nested_data)) {
            div(
              class = "nested-fields-container",
              div(class = "nested-fields-header", "Nested Fields"),
              reactable(
                nested_data,
                pagination = FALSE,
                outlined = TRUE,
                defaultColDef = colDef(headerClass = "header"),
                columns = list(
                  Field = colDef(
                    name = "Field",
                    style = list(fontWeight = 500, fontSize = "0.8125rem")
                  ),
                  Type = colDef(
                    name = "Type",
                    style = list(fontSize = "0.8125rem")
                  ),
                  Description = colDef(
                    name = "Description",
                    style = list(fontSize = "0.8125rem")
                  )
                ),
                class = "schema-table",
                theme = reactableTheme(cellPadding = "8px 12px")
              )
            )
          }
        },
        class = "schema-table",
        theme = reactableTheme(cellPadding = "8px 12px")
      )
    )
    return(detail)
  }
}

# Main table
div(
  class = "bigquery-tables",
  reactable(
    table_metadata[, c("name", "lastModifiedTime", "location", "numBytes", "numRows")],
    onClick = "expand",
    resizable = TRUE,
    pagination = FALSE,
    defaultColDef = colDef(headerClass = "header"),
    columns = list(
      name = colDef(
        name = "Table Name",
        minWidth = 250,
        style = list(fontWeight = 600, cursor = "pointer", fontSize = "0.875rem")
      ),
      lastModifiedTime = colDef(
        name = "Last Updated",
        align = "right",
        minWidth = 200,
        style = list(fontSize = "0.875rem"),
        cell = function(value) {
          strftime(value, format = "%b %d, %Y %H:%M")
        }
      ),
      location = colDef(
        name = "Loc.",
        minWidth = 80,
        align = "right",
        style = list(fontSize = "0.875rem")
      ),
      numBytes = colDef(
        name = "Size",
        align = "right",
        minWidth = 150,
        vAlign = "center",
        style = list(fontFamily = "ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace", fontSize = "0.8125rem"),
        cell = function(value) {
          if (is.na(value)) return("—")
          size_gb <- value / (1024^3)
          if (size_gb >= 1) {
            paste0(format(round(size_gb, 2), nsmall = 2), " GB")
          } else {
            size_mb <- value / (1024^2)
            paste0(format(round(size_mb, 2), nsmall = 2), " MB")
          }
        }
      ),
      numRows = colDef(
        name = "Rows",
        align = "right",
        minWidth = 150,
        vAlign = "center",
        style = list(fontFamily = "ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace", fontSize = "0.8125rem"),
        cell = function(value) {
          if (is.na(value)) return("—")
          format(value, big.mark = ",", scientific = FALSE)
        }
      )
    ),
    details = table_details,
    rowStyle = list(cursor = "pointer"),
    theme = reactableTheme(
      cellPadding = "8px 12px",
      style = list(fontFamily = "system-ui, -apple-system, sans-serif")
    )
  )
)
```
